{% extends 'base.html' %}
{% load static %}

{% block title %}Nearby Shops Finder - Find Local Businesses{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section text-center rounded-3 mb-5 position-relative overflow-hidden">
    <div class="container py-5 position-relative" style="z-index: 2;">
        <div class="hero-content" style="animation: fadeInUp 1s ease-out;">
            <h1 class="display-4 fw-bold text-white mb-4" style="text-shadow: 0 4px 8px rgba(0,0,0,0.3);">
                <i class="bi bi-geo-alt-fill me-3" style="animation: bounce 2s infinite;"></i>
                Nearby Shops Finder
            </h1>
            <p class="lead text-white mb-4" style="text-shadow: 0 2px 4px rgba(0,0,0,0.3); animation: fadeInUp 1s ease-out 0.3s both;">
                Discover local businesses and services near you. Find the nearest shops, restaurants, and more with just a click!
            </p>
            <div class="d-flex justify-content-center gap-3 flex-wrap" style="animation: fadeInUp 1s ease-out 0.6s both;">
                <a href="{% url 'viewpoints' %}" class="btn btn-light btn-lg px-4 shadow-lg">
                    <i class="bi bi-search me-2"></i>Find Nearby
                </a>
                <a href="{% url 'addpoint' %}" class="btn btn-outline-light btn-lg px-4 shadow-lg">
                    <i class="bi bi-plus-circle me-2"></i>Add Location
                </a>
            </div>
        </div>
    </div>
    
    <!-- Floating Elements -->
    <div class="floating-elements">
        <div class="floating-icon" style="position: absolute; top: 20%; left: 10%; animation: float 6s ease-in-out infinite;">
            <i class="bi bi-shop text-white opacity-25" style="font-size: 2rem;"></i>
        </div>
        <div class="floating-icon" style="position: absolute; top: 60%; right: 15%; animation: float 8s ease-in-out infinite reverse;">
            <i class="bi bi-geo-alt text-white opacity-25" style="font-size: 1.5rem;"></i>
        </div>
        <div class="floating-icon" style="position: absolute; bottom: 30%; left: 20%; animation: float 7s ease-in-out infinite;">
            <i class="bi bi-navigation text-white opacity-25" style="font-size: 1.8rem;"></i>
        </div>
    </div>
</div>

<!-- Stats Section -->
<div class="container mb-4">
    <div class="row align-items-center">
        <div class="col-md-6">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="bi bi-geo-alt-fill text-primary" style="font-size: 2rem;"></i>
                </div>
                <div>
                    <h3 class="fw-bold mb-0">{{ points|length }}</h3>
                    <p class="text-muted mb-0">Total Locations</p>
                </div>
            </div>
        </div>
        <div class="col-md-6 text-md-end">
            <a href="{% url 'viewpoints' %}" class="btn btn-outline-primary me-2">
                <i class="bi bi-search me-1"></i>Find Nearby
            </a>
            <a href="{% url 'addpoint' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i>Add Location
            </a>
        </div>
    </div>
</div>

<!-- Map Container -->
<div class="container mb-5">
    <div class="row">
        <div class="col-12">
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>
</div>

<!-- Locations List Section -->
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">
                    <i class="bi bi-list-ul me-2"></i>
                    All Locations
                </h2>
                <div class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Click on any location to view on map
                </div>
            </div>
        </div>
    </div>

    {% if points %}
    <div class="row">
        {% for point in points %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card location-card h-100 border-0 shadow-sm" data-lat="{{ point.location.y }}" data-lng="{{ point.location.x }}" data-id="{{ point.id }}">
                <div class="card-body">
                    <div class="d-flex align-items-start mb-3">
                        <div class="location-icon me-3">
                            <i class="bi bi-geo-alt-fill text-primary"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="card-title fw-bold mb-1">{{ point.name }}</h5>
                            <p class="text-muted small mb-0">
                                <i class="bi bi-geo-alt me-1"></i>
                                {{ point.location.y|floatformat:4 }}, {{ point.location.x|floatformat:4 }}
                            </p>
                        </div>
                    </div>
                    
                    {% if point.description %}
                    <p class="card-text text-muted">{{ point.description|truncatewords:15 }}</p>
                    {% else %}
                    <p class="card-text text-muted fst-italic">No description available</p>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <small class="text-muted">
                            <i class="bi bi-calendar me-1"></i>
                            Added recently
                        </small>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="showLocationOnMap({{ point.location.y }}, {{ point.location.x }}, '{{ point.name|escapejs }}')">
                                <i class="bi bi-eye me-1"></i>View
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="getDirections({{ point.location.y }}, {{ point.location.x }}, '{{ point.name|escapejs }}')">
                                <i class="bi bi-navigation me-1"></i>Directions
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <div class="mb-4">
            <i class="bi bi-geo-alt text-muted" style="font-size: 4rem;"></i>
        </div>
        <h3 class="text-muted mb-3">No Locations Yet</h3>
        <p class="text-muted mb-4">Be the first to add a location to our database!</p>
        <a href="{% url 'addpoint' %}" class="btn btn-primary btn-lg">
            <i class="bi bi-plus-circle me-2"></i>Add First Location
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize map
    var map = L.map('map').setView([11, 79], 7);
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Store markers and popup data
    var markers = {};
    var popupData = {};
    
    // Add markers for all points
    {% for point in points %}
        var marker{{ point.id }} = L.marker([{{ point.location.y }}, {{ point.location.x }}])
            .addTo(map);
        
        // Store marker reference
        markers[{{ point.id }}] = marker{{ point.id }};
        
        // Store popup data
        popupData[{{ point.id }}] = {
            name: "{{ point.name|escapejs }}",
            description: "{{ point.description|default:'No description available'|escapejs }}",
            lat: {{ point.location.y }},
            lng: {{ point.location.x }}
        };
        
        // Create popup content
        var popupContent = `
            <div class="popup-content">
                <h6 class="fw-bold mb-2">${popupData[{{ point.id }}].name}</h6>
                <p class="text-muted small mb-2">${popupData[{{ point.id }}].description}</p>
                <div class="btn-group btn-group-sm w-100">
                    <button class="btn btn-outline-primary btn-sm" onclick="showLocationDetails('${popupData[{{ point.id }}].name}', '${popupData[{{ point.id }}].description}', ${popupData[{{ point.id }}].lat}, ${popupData[{{ point.id }}].lng})">
                        <i class="bi bi-eye me-1"></i>Details
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="getDirections(${popupData[{{ point.id }}].lat}, ${popupData[{{ point.id }}].lng}, '${popupData[{{ point.id }}].name}')">
                        <i class="bi bi-navigation me-1"></i>Directions
                    </button>
                </div>
            </div>
        `;
        
        marker{{ point.id }}.bindPopup(popupContent);
        
        // Add click event to highlight in cards
        marker{{ point.id }}.on('click', function(e) {
            highlightLocationCard({{ point.id }});
        });
    {% endfor %}
    
    // Location card click handlers
    document.querySelectorAll('.location-card').forEach(card => {
        card.addEventListener('click', function() {
            const lat = parseFloat(this.dataset.lat);
            const lng = parseFloat(this.dataset.lng);
            const id = this.dataset.id;
            
            showLocationOnMap(lat, lng, popupData[id].name);
            highlightLocationCard(id);
        });
    });
    
    // Functions
    function showLocationOnMap(lat, lng, name) {
        map.setView([lat, lng], 15);
        if (markers[Object.keys(markers).find(key => popupData[key].name === name)]) {
            markers[Object.keys(markers).find(key => popupData[key].name === name)].openPopup();
        }
    }
    
    function highlightLocationCard(id) {
        // Remove previous highlights
        document.querySelectorAll('.location-card').forEach(card => {
            card.classList.remove('active');
        });
        
        // Highlight current card
        const card = document.querySelector(`[data-id="${id}"]`);
        if (card) {
            card.classList.add('active');
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    
    function showLocationDetails(name, description, lat, lng) {
        document.getElementById('modalLocationName').textContent = name;
        document.getElementById('modalLocationDesc').textContent = description;
        document.getElementById('modalLocationCoords').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        
        // Store coordinates for directions
        document.getElementById('modalDirectionsBtn').onclick = function() {
            getDirections(lat, lng, name);
        };
        
        const modal = new bootstrap.Modal(document.getElementById('locationModal'));
        modal.show();
    }
    
    function getDirections(lat, lng, name) {
        const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
        window.open(url, '_blank');
    }
    
    // Add smooth scrolling for better UX
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelector(this.getAttribute('href')).scrollIntoView({
                behavior: 'smooth'
            });
        });
    });
</script>

<!-- Location Details Modal -->
<div class="modal fade" id="locationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-geo-alt-fill me-2"></i>
                    Location Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 class="fw-bold">Name:</h6>
                <p id="modalLocationName" class="mb-3"></p>
                
                <h6 class="fw-bold">Description:</h6>
                <p id="modalLocationDesc" class="mb-3"></p>
                
                <h6 class="fw-bold">Coordinates:</h6>
                <p id="modalLocationCoords" class="text-muted"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="modalDirectionsBtn">
                    <i class="bi bi-navigation me-1"></i>Get Directions
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Map Container */
.map-container {
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    height: 500px;
}

#map {
    height: 100%;
    width: 100%;
}

/* Location Cards */
.location-card {
    cursor: pointer;
    transition: all 0.3s ease;
}

.location-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.1) !important;
}

.location-card.active {
    border: 2px solid #0d6efd !important;
    box-shadow: 0 15px 35px rgba(13, 110, 253, 0.2) !important;
    transform: translateY(-5px);
}

.location-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

/* Popup Styles */
.popup-content {
    min-width: 200px;
}

.popup-content .btn-group {
    margin-top: 0.5rem;
}

/* Button Group Styles */
.btn-group .btn {
    border-radius: 6px;
    margin: 0 1px;
}

.btn-group .btn:first-child {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}

.btn-group .btn:last-child {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
}

/* Enhanced Animations */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
    }
    40% {
        transform: translateY(-10px);
    }
    60% {
        transform: translateY(-5px);
    }
}

@keyframes float {
    0%, 100% {
        transform: translateY(0px) rotate(0deg);
    }
    50% {
        transform: translateY(-20px) rotate(5deg);
    }
}

@keyframes pulse {
    0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
    }
    70% {
        transform: scale(1.05);
        box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
    }
}

@keyframes shimmer {
    0% {
        background-position: -200% 0;
    }
    100% {
        background-position: 200% 0;
    }
}

/* Enhanced Location Cards */
.location-card {
    animation: fadeInUp 0.6s ease-out;
    animation-fill-mode: both;
}

.location-card:nth-child(1) { animation-delay: 0.1s; }
.location-card:nth-child(2) { animation-delay: 0.2s; }
.location-card:nth-child(3) { animation-delay: 0.3s; }
.location-card:nth-child(4) { animation-delay: 0.4s; }
.location-card:nth-child(5) { animation-delay: 0.5s; }
.location-card:nth-child(6) { animation-delay: 0.6s; }

/* Enhanced Buttons */
.btn {
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
}

.btn:hover::before {
    left: 100%;
}

.btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}

/* Enhanced Map Container */
.map-container {
    animation: fadeInUp 0.8s ease-out;
    position: relative;
}

.map-container::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent 30%, rgba(102, 126, 234, 0.1) 50%, transparent 70%);
    background-size: 200% 200%;
    animation: shimmer 3s ease-in-out infinite;
    pointer-events: none;
    z-index: 1;
}

/* Responsive Design */
@media (max-width: 768px) {
    .map-container {
        height: 400px;
    }
    
    .hero-section h1 {
        font-size: 2rem;
    }
    
    .hero-section p {
        font-size: 1rem;
    }
    
    .location-card {
        margin-bottom: 1rem;
    }
    
    .floating-elements {
        display: none;
    }
}
</style>
{% endblock %}
